name: AI Tool Site ‚Äì Full Auto Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Get code
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Python for generators
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Install Python deps (safe + minimal)
      - name: Install Python dependencies
        run: |
          pip install requests beautifulsoup4 google-cloud-firestore

      # 4Ô∏è‚É£ Generate AI tool using Gemini
      - name: Generate AI Tool (Gemini)
        run: python ai_tool_generator.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      # 5Ô∏è‚É£ Build site from template
      - name: Build Site
        run: python generator.py

      # 6Ô∏è‚É£ SEO + AdSense safety checks
      - name: SEO Validation
        run: |
          for f in sites/*/index.html; do
            python seo_check.py "$f"
          done

      # 7Ô∏è‚É£ Save metadata (optional, non-blocking)
      - name: Save metadata to Firestore
        run: python firestore_save.py || echo "Firestore skipped"
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GCP_SERVICE_KEY }}

      # 8Ô∏è‚É£ Auto cleanup (prevents thin content / penalties)
      - name: Cleanup old sites
        run: python cleanup.py

      # 9Ô∏è‚É£ Commit generated content
      - name: Commit changes
        run: |
          git config user.name "AI Agent"
          git config user.email "ai@system.local"
          git add .
          git commit -m "Auto AI tool site deploy" || echo "No changes"

      - name: Push changes
        run: git push

      # üîü Deploy to Cloudflare Pages (NO OAuth)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Pages
        run: |
          wrangler pages deploy . \
            --project-name=ai-sites \
            --branch=main
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}